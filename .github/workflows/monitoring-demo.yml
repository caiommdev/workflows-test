
name: Monitoring and Debugging Demo

on:
  workflow_dispatch:
    inputs:
      simulate_failure:
        description: 'Simular falha no workflow'
        required: false
        type: boolean
        default: false
      check_type:
        description: 'Tipo de verificaÃ§Ã£o'
        required: true
        type: choice
        options:
          - all
          - dependencies
          - security
          - performance

jobs:
  monitoring-demo:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: Inicializar resumo do job
      run: |
        echo "# ðŸ“Š RelatÃ³rio de Monitoramento" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Data:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "**Executado por:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tipo de verificaÃ§Ã£o:** ${{ inputs.check_type }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: VerificaÃ§Ã£o de DependÃªncias
      if: inputs.check_type == 'all' || inputs.check_type == 'dependencies'
      run: |
        echo "::group::Verificando dependÃªncias"
        
        echo "::notice::Iniciando verificaÃ§Ã£o de dependÃªncias..."
        
        # Simular verificaÃ§Ã£o
        OUTDATED_DEPS=2
        
        if [ $OUTDATED_DEPS -gt 0 ]; then
          echo "::warning::Encontradas $OUTDATED_DEPS dependÃªncias desatualizadas"
          
          echo "## âš ï¸ DependÃªncias Desatualizadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| DependÃªncia | VersÃ£o Atual | VersÃ£o Mais Recente |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------------|---------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| spring-boot | 2.7.0 | 3.2.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| junit | 4.13.2 | 5.10.1 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "::notice::Todas as dependÃªncias estÃ£o atualizadas âœ“"
          echo "## âœ… DependÃªncias" >> $GITHUB_STEP_SUMMARY
          echo "Todas as dependÃªncias estÃ£o atualizadas." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "::endgroup::"
    
    - name: VerificaÃ§Ã£o de SeguranÃ§a
      if: inputs.check_type == 'all' || inputs.check_type == 'security'
      run: |
        echo "::group::AnÃ¡lise de seguranÃ§a"
        
        # Simular scan de seguranÃ§a
        VULNERABILITIES=1
        
        if [ $VULNERABILITIES -gt 0 ]; then
          echo "::warning::Encontradas $VULNERABILITIES vulnerabilidades"
          
          echo "## ðŸ”’ Vulnerabilidades de SeguranÃ§a" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severidade | CVE | Componente | AÃ§Ã£o Recomendada |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-----|------------|------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| MEDIUM | CVE-2023-12345 | log4j | Atualizar para v2.20.0 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "::notice::Nenhuma vulnerabilidade crÃ­tica encontrada âœ“"
          echo "## âœ… SeguranÃ§a" >> $GITHUB_STEP_SUMMARY
          echo "Nenhuma vulnerabilidade crÃ­tica detectada." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "::endgroup::"
    
    - name: VerificaÃ§Ã£o de Performance
      if: inputs.check_type == 'all' || inputs.check_type == 'performance'
      run: |
        echo "::group::MÃ©tricas de performance"
        
        # Simular mÃ©tricas
        BUILD_TIME=45
        ARTIFACT_SIZE=15
        
        echo "## ðŸ“ˆ MÃ©tricas de Performance" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| MÃ©trica | Valor | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Tempo de Build | ${BUILD_TIME}s | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Tamanho do Artefato | ${ARTIFACT_SIZE}MB | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Cobertura de Testes | 78% | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ $BUILD_TIME -gt 60 ]; then
          echo "::warning::Tempo de build acima do esperado (${BUILD_TIME}s). Considere otimizar o processo."
        fi
        
        if [ $ARTIFACT_SIZE -gt 50 ]; then
          echo "::warning::Artefato muito grande (${ARTIFACT_SIZE}MB). Considere remover dependÃªncias nÃ£o utilizadas."
        fi
        
        echo "::endgroup::"
    
    - name: DiagnÃ³stico Automatizado de Falhas
      if: inputs.simulate_failure
      run: |
        echo "::group::DiagnÃ³stico de Falha"
        
        # Simular condiÃ§Ã£o de falha
        CONDITION_MET=false
        
        if [ "$CONDITION_MET" = false ]; then
          echo "::error::Falha detectada na verificaÃ§Ã£o de condiÃ§Ãµes"
          
          echo "## âŒ Falha Detectada" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DiagnÃ³stico" >> $GITHUB_STEP_SUMMARY
          echo "A condiÃ§Ã£o esperada nÃ£o foi atendida." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PossÃ­veis Causas" >> $GITHUB_STEP_SUMMARY
          echo "1. ConfiguraÃ§Ã£o incorreta no ambiente" >> $GITHUB_STEP_SUMMARY
          echo "2. DependÃªncias faltando" >> $GITHUB_STEP_SUMMARY
          echo "3. Falha em step anterior" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SugestÃµes de CorreÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- Verifique os logs dos steps anteriores" >> $GITHUB_STEP_SUMMARY
          echo "- Confirme que todas as variÃ¡veis de ambiente estÃ£o configuradas" >> $GITHUB_STEP_SUMMARY
          echo "- Execute o comando \`mvn clean install\` localmente para reproduzir" >> $GITHUB_STEP_SUMMARY
          echo "- Consulte a documentaÃ§Ã£o em [README.md](../README.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "::endgroup::"
          exit 1
        fi
    
    - name: Resumo Final
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… **Status:** Sucesso" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Todas as verificaÃ§Ãµes foram concluÃ­das com sucesso!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status:** Falha" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Algumas verificaÃ§Ãµes falharam. Consulte os detalhes acima." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tempo de execuÃ§Ã£o:** $(date '+%H:%M:%S')" >> $GITHUB_STEP_SUMMARY