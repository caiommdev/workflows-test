name: Deploy Pipeline with Tests

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: Configurar JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Executar testes
      run: mvn clean test
    
    - name: Publicar relat√≥rio de testes
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Resultados dos Testes
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: true

  deploy:
    runs-on: ubuntu-latest
    needs: test
    environment: production
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: Configurar JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Build da aplica√ß√£o
      run: mvn clean package -DskipTests
    
    - name: Simular Deploy
      run: |
        echo "::group::Informa√ß√µes de Deploy"
        echo "Tag/Vers√£o: ${GITHUB_REF#refs/tags/}"
        echo "Commit SHA: $GITHUB_SHA"
        echo "Actor: $GITHUB_ACTOR"
        echo "Reposit√≥rio: $GITHUB_REPOSITORY"
        echo "::endgroup::"
        
        echo "::notice::Iniciando deploy para produ√ß√£o..."
        sleep 2
        
        JAR_FILE=$(find target -name "*.jar" | head -n 1)
        if [ -n "$JAR_FILE" ]; then
          echo "::notice::Deploy do arquivo $JAR_FILE conclu√≠do com sucesso!"
        else
          echo "::error::Nenhum arquivo JAR encontrado para deploy"
          exit 1
        fi
    
    - name: Verifica√ß√£o p√≥s-deploy
      run: |
        echo "::group::Verifica√ß√µes de Sa√∫de"
        echo "‚úì Aplica√ß√£o deployada"
        echo "‚úì Servi√ßo iniciado"
        echo "‚úì Health check passou"
        echo "::endgroup::"
        
        echo "::notice::Deploy finalizado com sucesso! üöÄ"